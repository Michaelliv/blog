---
import Analytics from '@vercel/analytics/astro';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

function getExcerpt(body: string, maxLength: number = 1200) {
	const stripped = body.replace(/^---[\s\S]*?---/, '').trim();
	const totalWords = stripped.split(/\s+/).length;

	if (stripped.length <= maxLength) {
		return { text: stripped, truncated: false, totalWords };
	}

	const truncated = stripped.slice(0, maxLength);
	const lastSpace = truncated.lastIndexOf(' ');
	return {
		text: truncated.slice(0, lastSpace),
		truncated: true,
		totalWords
	};
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Blog - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<h1>Posts</h1>
			<div class="post-list">
				{posts.map((post) => {
					const excerpt = getExcerpt(post.body || '');
					return (
						<article class="post-preview">
							<header>
								<span class="date"><FormattedDate date={post.data.pubDate} /></span>
								{post.data.tags && (
									<span class="tags">
										{post.data.tags.map((tag) => (
											<span class="tag">{tag}</span>
										))}
									</span>
								)}
							</header>
							<h2><a href={`/blog/${post.id}/`}>{post.data.title}</a></h2>
							<div class="excerpt">
								<p>{excerpt.text}{excerpt.truncated && '...'}</p>
								{excerpt.truncated && (
									<p class="word-count">[... {excerpt.totalWords} words]</p>
								)}
							</div>
						</article>
					);
				})}
			</div>
		</main>
		<Footer />
		<Analytics />
	</body>
</html>

<style>
	h1 {
		margin-top: 0;
	}
	.post-list {
		margin: 0;
	}
	.post-preview {
		margin-bottom: 2rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid var(--border);
	}
	.post-preview:last-child {
		border-bottom: none;
	}
	.post-preview header {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-bottom: 0.5rem;
	}
	.post-preview h2 {
		margin: 0 0 0.5rem 0;
		font-size: 1.25rem;
	}
	.post-preview h2 a {
		text-decoration: none;
	}
	.post-preview h2 a:hover {
		text-decoration: underline;
	}
	.date {
		color: var(--text-light);
		font-size: 0.875rem;
		font-family: "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
	}
	.tags {
		display: flex;
		gap: 0.5rem;
	}
	.tag {
		font-size: 0.75rem;
		color: var(--text-light);
	}
	.tag::before {
		content: '#';
	}
	.excerpt {
		line-height: 1.6;
	}
	.excerpt p {
		margin: 0;
	}
	.word-count {
		color: var(--text-light);
		font-size: 0.875rem;
		margin-top: 0.5rem !important;
	}
</style>
