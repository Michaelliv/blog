---
import Analytics from '@vercel/analytics/astro';
import { getCollection, render } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
).slice(0, 10);

// Render all posts and get their HTML content
const postsWithContent = await Promise.all(
	posts.map(async (post) => {
		const { Content } = await render(post);
		const totalWords = (post.body || '').split(/\s+/).length;
		return { post, Content, totalWords };
	})
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<h1>Recent posts</h1>
			<div class="post-list">
				{postsWithContent.map(({ post, Content, totalWords }) => (
					<article class="post-preview">
						<h2><a href={`/blog/${post.id}/`}>{post.data.title}</a></h2>
						<div class={totalWords > 200 ? 'excerpt truncated' : 'excerpt'}>
							<Content />
						</div>
						{totalWords > 200 && (
							<p class="read-more">
								<a href={`/blog/${post.id}/`}>[... {totalWords} words]</a>
							</p>
						)}
						<div class="meta">
							<span class="date"><FormattedDate date={post.data.pubDate} /></span>
							{post.data.tags && (
								<span class="tags">
									{post.data.tags.map((tag) => (
										<span class="tag">{tag}</span>
									))}
								</span>
							)}
						</div>
					</article>
				))}
			</div>
			<p class="all-posts"><a href="/blog">All posts &rarr;</a></p>
		</main>
		<Footer />
		<Analytics />
	</body>
</html>

<style>
	h1 {
		margin-top: 0;
	}
	.post-list {
		margin: 0 0 2rem 0;
	}
	.post-preview {
		margin-bottom: 2rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid var(--border);
	}
	.post-preview:last-child {
		border-bottom: none;
	}
	.post-preview h2 {
		margin: 0 0 0.25rem 0;
		font-size: 1.25rem;
	}
	.meta {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-top: 0.5rem;
	}
	.post-preview h2 a {
		text-decoration: none;
	}
	.post-preview h2 a:hover {
		text-decoration: underline;
	}
	.date {
		color: var(--text-light);
		font-size: 0.875rem;
		font-family: "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
	}
	.tags {
		display: flex;
		gap: 0.5rem;
	}
	.tag {
		font-size: 0.75rem;
		color: var(--text-light);
	}
	.tag::before {
		content: '#';
	}
	.excerpt {
		line-height: 1.3;
		font-size: 0.9rem;
	}
	.excerpt.truncated {
		max-height: 18em;
		overflow: hidden;
		position: relative;
	}
	.excerpt.truncated::after {
		content: '';
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		height: 2.5em;
		background: linear-gradient(transparent, white);
	}
	.excerpt :global(p) {
		margin: 0 0 0.35em 0;
	}
	.excerpt :global(h1),
	.excerpt :global(h2),
	.excerpt :global(h3),
	.excerpt :global(h4),
	.excerpt :global(h5),
	.excerpt :global(h6) {
		font-size: 0.9rem !important;
		font-weight: 600;
		margin: 0.5em 0 0.15em 0;
	}
	.excerpt :global(ul),
	.excerpt :global(ol) {
		margin: 0.2em 0;
		padding-left: 1.1rem;
	}
	.excerpt :global(li) {
		margin-bottom: 0;
	}
	.read-more {
		color: var(--text-light);
		font-size: 0.875rem;
		margin-top: 0.5rem;
	}
	.all-posts {
		margin: 0;
	}
</style>
